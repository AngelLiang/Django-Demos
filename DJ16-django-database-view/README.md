# Django使用数据库视图

## 步骤


第一步：创建数据库迁移文件

    python manage.py makemigrations --empty app01


第二步：编辑数据库迁移文件，使用纯SQL语句创建数据库视图

    # Generated by Django 3.0.5 on 2020-04-26 02:33

    from django.db import migrations
    from django.db import connection

    cursor = connection.cursor()


    def forwards_func(apps, schema_editor):
        """创建视图"""
        sql = r'CREATE VIEW temp_user AS SELECT id, username, first_name FROM auth_user;'
        cursor.execute(sql)


    def reverse_func(apps, schema_editor):
        """删除视图"""
        sql = r'DROP VIEW temp_user;'
        cursor.execute(sql)


    class Migration(migrations.Migration):

        dependencies = [
        ]

        operations = [
            migrations.RunPython(forwards_func, reverse_func)
        ]


第三步：创建相关模型和管理视图

模型

    # models.py
    from django.db import models

    class TempUser(models.Model):
        username = models.CharField(max_length=128)
        first_name = models.CharField(max_length=100)

        class Meta:
            managed = False
            db_table = "temp_user"

管理视图

    # admin.py
    from django.contrib import admin

    from . import models


    class TempUserViewAdmin(admin.ModelAdmin):
        """数据库视图不可编辑"""

        def has_add_permission(self, request):
            return False

        def has_change_permission(self, request, obj=None):
            return False

        def has_delete_permission(self, request, obj=None):
            return False


    admin.site.register(models.TempUser, TempUserViewAdmin)


第四步：完成。
